---
# SPDX-License-Identifier: Apache-2.0 OR MIT
# Copyright 2020 Modio AB

# We use a slightly modified `rust:buster` image
# See Dockerfile.build for details on what this image does differently compared
# to upstream `rust:buster` container
image: registry.gitlab.com/modioab/caramel-client-rs/build:master

include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

stages:
  - test
  - build
  - deploy

# Use cargo to test the project
test:cargo:
  script:
    - rustc --version && cargo --version  # Print version info for debugging
    - cargo test --workspace --verbose

lint:
  script:
    - cargo fmt -- --check
    - cargo clippy --tests -- -D clippy::pedantic -D clippy::cargo

crosscompile:
  script:
    - cargo check --target x86_64-unknown-linux-gnu
    - cargo check --target armv7-unknown-linux-gnueabihf
    # Build
    - cargo build --target x86_64-unknown-linux-gnu
    - cargo build --target x86_64-unknown-linux-musl
    - cargo build --target armv7-unknown-linux-gnueabihf
    - cargo doc --no-deps -p caramel-client


# This builds the "client" container that others can use to run the application.
release:container:
  stage: deploy
  image: registry.gitlab.com/modioab/base-image/fedora-31/container:master
  needs:
    - job: release
      artifacts: true
  rules:
    # Build when any of these files change
    - changes:
        - Dockerfile
        - Makefile
        - build.mk
    # Always build on tags
    - if: '$CI_COMMIT_TAG'
      when: on_success
    # Always build from scheduled builds
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
    # Allow users to _manually_ build this from merge-requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      # If it's not tagged as "allow_failure", it will block the merge request
      # pipelines
      allow_failure: true
      when: manual
    # Do not build on other conditions
    - when: never
  script:
    - make login
    # Build the client container
    - make -f Makefile build-publish

# Compile a binary, uploading an artifact to the GitLab server
release:
  stage: build
  rules:
    # Always build on tags
    - if: '$CI_COMMIT_TAG'
      when: on_success
    # Permit binary builds from merge-requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      # If it's not tagged as "allow_failure", it will block the merge request
      # pipelines
      allow_failure: true
      when: manual
    # Do not build on other conditions
    - when: never
  script:
    - cargo build --release --target x86_64-unknown-linux-gnu
    - ( cd target/x86_64-unknown-linux-gnu/release;
        sha256sum caramel-client-rs > caramel-client-rs.sha256 )
    - cargo build --release --target x86_64-unknown-linux-musl
    - ( cd target/x86_64-unknown-linux-musl/release;
        sha256sum caramel-client-rs > caramel-client-rs.sha256 )
    - cargo build --release --target armv7-unknown-linux-gnueabihf
    - ( cd target/armv7-unknown-linux-gnueabihf/release;
        sha256sum caramel-client-rs > caramel-client-rs.sha256 )

  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - target/*/release/caramel-client-rs
      - target/*/release/caramel-client-rs.sha256

.rebase: &rebase
  stage: build
  allow_failure: true
  needs:
    - job: lint
      artifacts: false
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # do not run on master
      when: never

    - if: $CI_COMMIT_TAG
      # Do not run on tags
      when: never

    - if: $CI_MERGE_REQUEST_IID
      # Run only on merge requests
      when: on_success

  variables:
    # Make sure that git also fetches origin/master
    GIT_FETCH_EXTRA_FLAGS: master

  before_script:
    - git config --global user.email "ci@localhost"
    - git config --global user.name "CI System"


# Split check & fmt as two different jobs only so that we don't error early in
# case one of them fails
rebase:check:
  <<: *rebase
  script:
    - git rebase --rebase-merges --autosquash origin/master
      -x 'git --no-pager log --oneline --max-count=1'
      -x 'cargo check'

rebase:fmt:
  <<: *rebase
  script:
    - git rebase --rebase-merges --autosquash origin/master
      -x 'git --no-pager log --oneline --max-count=1'
      -x 'cargo fmt -- --check'

rebase:clippy:
  <<: *rebase
  script:
    - git rebase --rebase-merges --autosquash origin/master
      -x 'git --no-pager log --oneline --max-count=1'
      -x 'cargo clippy --tests -- -D clippy::pedantic -D clippy::cargo'

rebase:doc:
  <<: *rebase
  script:
    - git rebase --rebase-merges --autosquash origin/master
      -x 'git --no-pager log --oneline --max-count=1'
      -x 'cargo doc --no-deps -p caramel-client'


# This is to publish the documentation to external site
# https://modioab.gitlab.io/caramel-client-rs/
pages:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # only run on master
      when: on_success
    - when: never
  script:
    - cargo doc --no-deps -p caramel-client
    - rm -rf public
    - mv target/doc/ public
    - echo '<meta http-equiv="refresh" content="0; url=caramel_client">' > public/index.html
  artifacts:
    paths:
      - public


# This build the "build" container
container:build:
  stage: build
  image: registry.gitlab.com/modioab/base-image/fedora-31/container:master
  rules:
    # Build when any of these files change
    - changes:
        - Dockerfile.build
        - Makefile.build
        - build.mk
    # Always build from scheduled builds
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
    # Allow users to _manually_ build this from merge-requests in cases.
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      # If it's not tagged as "allow_failure", it will block the merge request
      # pipelines
      allow_failure: true
      when: manual
    # Do not build on other conditions
    - when: never
  script:
    - make login
    # Build the dev containers
    - make -f Makefile.build build-publish
